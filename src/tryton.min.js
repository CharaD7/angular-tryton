"use strict";angular.module("openlabs.angular-tryton",["ngCookies"]).config(["$httpProvider",function($httpProvider){var trytonResponseInterceptor=["$q","$rootScope",function($q,$rootScope){function success(response){if(response.data.__error__){var error=angular.copy(response.data);return"NotLogged"==error[0]?$rootScope.$broadcast("tryton:NotLogged"):"UserError"==error[0]?$rootScope.$broadcast("tryton:UserError",error[1],error[2]):"UserWarning"==error[0]?$rootScope.$broadcast("tryton:UserWarning",error[1],error[2],error[3]):"ConcurrencyException"==error[0]?$rootScope.$broadcast("tryton:ConcurrencyException",error[1]):$rootScope.$broadcast("tryton:Exception",error),$q.reject(response)}return response||$q.when(response)}function error(response){return $q.reject(response)}return function(promise){return promise.then(success,error)}}];$httpProvider.responseInterceptors.push(trytonResponseInterceptor);var trytonResponseTransformer=function(response){if(response.hasOwnProperty("result"))return response.result;if(response.hasOwnProperty("error")){var error=response.error;return error.__error__=!0,error}return response};$httpProvider.defaults.transformResponse.push(trytonResponseTransformer)}]).factory("tryton",["$http",function($http){var serverUrl="/",rpc=function(method,params,database){var request=$http.post(serverUrl+(database||""),{method:method,params:params||[]});return request},getServerVersion=function(){return rpc("common.version",[null,null])},self={rpc:rpc,getServerVersion:getServerVersion};return self}]).factory("session",["tryton","$cookieStore",function(tryton,$cookieStore){var userId=null,sessionId=null,database=null,login=null,context=null,loadAllFromCookies=function(){userId=$cookieStore.get("userId"),sessionId=$cookieStore.get("sessionId"),database=$cookieStore.get("database"),login=$cookieStore.get("login"),context=$cookieStore.get("context")};loadAllFromCookies();var clearSession=function(){userId=null,sessionId=null,context=null,$cookieStore.remove("userId"),$cookieStore.remove("sessionId"),$cookieStore.remove("context")},setSession=function(_database,_login,_userId,_sessionId){$cookieStore.put("database",_database||null),$cookieStore.put("login",_login||null),$cookieStore.put("userId",_userId||null),$cookieStore.put("sessionId",_sessionId||null),loadAllFromCookies()},rpc=function(_method,_params,_context){var params=[userId,sessionId].concat(_params||[]),requestContext=angular.copy(context||{});return void 0!==_context&&angular.extend(requestContext,_context),params.push(requestContext),tryton.rpc(_method,params,database)},doLogout=function(){var promise=rpc("common.db.logout");return clearSession(),promise},doLogin=function(_database,_username,_password){var promise=tryton.rpc("common.login",[_username,_password],_database).success(function(result){result instanceof Array&&setSession(_database,_username,result[0],result[1])});return promise};return{doLogin:doLogin,doLogout:doLogout,rpc:rpc,setSession:setSession,database:database,sessionId:sessionId}}]);