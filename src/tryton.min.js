"use strict";angular.module("openlabs.angular-tryton",["ngStorage"]).config(["$httpProvider","sessionProvider",function($httpProvider,sessionProvider){var trytonResponseInterceptor=["$q","$rootScope",function($q,$rootScope){function success(response){if(response.data&&response.data.__error__){var error=angular.copy(response.data);return"NotLogged"==error[0]?$rootScope.$broadcast("tryton:NotLogged"):"UserError"==error[0]?$rootScope.$broadcast("tryton:UserError",error[1],error[2]):"UserWarning"==error[0]?$rootScope.$broadcast("tryton:UserWarning",error[1],error[2],error[3]):"ConcurrencyException"==error[0]?$rootScope.$broadcast("tryton:ConcurrencyException",error[1]):$rootScope.$broadcast("tryton:Exception",error),$q.reject(response)}return response||$q.when(response)}function error(response){return $q.reject(response)}return{response:success,responseError:error}}];$httpProvider.interceptors.push(trytonResponseInterceptor);var trytonResponseTransformer=function(response,headerGetter){if(response.hasOwnProperty("result"))return angular.forEach(response.result,function(record,recordKey){angular.forEach(record,function(field,fieldKey){if(field&&field.hasOwnProperty("__class__"))switch(field.__class__){case"Decimal":response.result[recordKey][fieldKey]=field.decimal;break;case"datetime":response.result[recordKey][fieldKey]=new Date(Date.UTC(field.year,field.month-1,field.day,field.hour,field.minute,field.second,field.microsecond/1e3)).toUTCString();break;case"date":var dateFormat=sessionProvider.context&&sessionProvider.context.locale.date||"%Y/%m/%d",replaceMap={"%Y":field.year,"%d":field.day,"%m":field.month};response.result[recordKey][fieldKey]=dateFormat.replace(/%Y|%m|%d/g,function(matched){return replaceMap[matched]});break;case"time":var date=new Date(null,null,null,field.hour,field.minute,field.second,field.microsecond/1e3).toUTCString();response.result[recordKey][fieldKey]=date.getUTCHours()+":"+date.getUTCMinutes()+":"+date.getUTCSeconds()+":"+date.getUTCMilliseconds();break;case"buffer":response.result[recordKey][fieldKey]=field.base64}})}),response.result;if(response.hasOwnProperty("error")){var error=response.error;return error.__error__=!0,error}return response};$httpProvider.defaults.transformResponse.push(trytonResponseTransformer)}]).service("tryton",["$http","$rootScope","$localStorage",function($http,$rootScope,$localStorage){var tryton=this;this.serverUrl=$localStorage.serverUrl||"/",this.setServerUrl=function(url){tryton.serverUrl=$localStorage.serverUrl=url+("/"===url.slice(-1)?"":"/")},this.rpc=function(method,params,database){var request=$http.post(tryton.serverUrl+(database||""),{method:method,params:params||[]});return request},this.getServerVersion=function(){return tryton.rpc("common.version",[null,null])}}]).service("session",["tryton","$localStorage","$sessionStorage","$q",function(tryton,$localStorage,$sessionStorage,$q){var session=this;this.userId=null,this.sessionId=null,this.database=null,this.login=null,session.context=null,session.loadAllFromStorage=function(){session.userId=$localStorage.userId,session.sessionId=$sessionStorage.sessionId,session.database=$localStorage.database,session.login=$localStorage.login,session.context=$sessionStorage.context,tryton.serverUrl=$localStorage.serverUrl||"/"},session.loadAllFromStorage();var clearSession=function(){session.userId=null,session.sessionId=null,session.context=null,delete $localStorage.userId,delete $sessionStorage.sessionId,delete $sessionStorage.context};this.setSession=function(_database,_login,_userId,_sessionId){$localStorage.database=_database||null,$localStorage.login=_login||null,$localStorage.userId=_userId||null,$sessionStorage.sessionId=_sessionId||null,session.loadAllFromStorage()},this.rpc=function(_method,_params,_context){var params=[session.userId,session.sessionId].concat(_params||[]),requestContext=angular.copy(session.context||{});return void 0!==_context&&angular.extend(requestContext,_context),params.push(requestContext),tryton.rpc(_method,params,session.database)},this.doLogout=function(){var promise=session.rpc("common.db.logout");return clearSession(),promise},this.setDefaultContext=function(_context){$sessionStorage.context=_context||null,session.loadAllFromStorage()};var _tryLogin=function(_database,_username,_password){var deferred=$q.defer();return tryton.rpc("common.login",[_username,_password],_database).success(function(result){result instanceof Array&&session.setSession(_database,_username,result[0],result[1]),deferred.resolve(result)}).error(function(reason){deferred.reject(reason)}),deferred.promise};this.doLogin=function(_database,_username,_password,getPreferences){var loginPromise,loginDeferred=$q.defer(),finalDeferred=$q.defer(),urlRegex=/^https?:\/\//i;urlRegex.test(tryton.serverUrl)||"/"===tryton.serverUrl?loginPromise=_tryLogin(_database,_username,_password):(tryton.setServerUrl("https://"+tryton.serverUrl),loginPromise=loginDeferred.promise,_tryLogin(_database,_username,_password).then(function(result){loginDeferred.resolve(result)},function(reason){reason?loginDeferred.reject(reason):(tryton.setServerUrl(tryton.serverUrl.replace(/^https/i,"http")),_tryLogin(_database,_username,_password).then(function(result){loginDeferred.resolve(result)},function(reason){loginDeferred.reject(reason)}))})),loginPromise.then(function(loginResponse){getPreferences?session.rpc("model.res.user.get_preferences",!0).success(function(preferences){session.setDefaultContext(preferences),finalDeferred.resolve(loginResponse)}).error(function(reason){finalDeferred.reject(reason)}):finalDeferred.resolve(loginResponse)},function(reason){finalDeferred.reject(reason)});var promise=finalDeferred.promise;return promise.success=function(fn){return promise.then(function(response){fn(response)}),promise},promise.error=function(fn){return promise.then(null,function(response){fn(response)}),promise},finalDeferred.promise},this.isLoggedIn=function(){return!!session.sessionId}}]).filter("urlTryton",function($window,tryton,session){return function(name,id,type_){if(type_=type_||"model",!name)throw new Error("Name in urlTryton filter is required.");var values=[],serverUrl=tryton.serverUrl;return serverUrl=/^[\w]+:\/\//.test(serverUrl)?serverUrl.substring(serverUrl.indexOf(":")):"://"+window.location.host+serverUrl,values.push(serverUrl+session.database),values.push(type_),values.push(name),id&&values.push(id),"tryton"+values.join("/")}});